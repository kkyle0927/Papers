function export_knn_ref_dataset_header(varargin)
% 사용법
% 1) export_knn_ref_dataset_header
%    -> MAT 선택 GUI + 저장 경로 GUI로 전체 데이터 export
% 2) export_knn_ref_dataset_header(matFilePath, outHeaderPath)
%    -> 경로 지정해서 전체 데이터 export
%
% [기능]
% 1. C/C++용 .h 헤더 파일 생성 (기존 기능)
% 2. Python용 .txt 파일 추가 생성 (numpy 포맷, split 변수 자동 포함)

    if nargin == 0
        [matName, matPath] = uigetfile({'*.mat','MAT-file (*.mat)'}, ...
            'Select reference dataset MAT file (e.g., refdataset_merged_scaled.mat)');
        if isequal(matName,0); return; end
        matFilePath = fullfile(matPath, matName);

        [hName, hPath] = uiputfile({'*.h','C header (*.h)'}, ...
            'Save as header file', fullfile(matPath, 'KNN_ref_dataset_v1.h'));
        if isequal(hName,0); return; end
        outHeaderPath = fullfile(hPath, hName);

    elseif nargin == 2
        matFilePath  = varargin{1};
        outHeaderPath = varargin{2};
    else
        error('사용법: export_knn_ref_dataset_header 또는 export_knn_ref_dataset_header(matFilePath,outHeaderPath)');
    end
    
    S = load(matFilePath);
    
    % 데이터 로드
    if isfield(S, 'ref_final_scaled')
        data = S.ref_final_scaled;
    elseif isfield(S, 'ref_norm')
        data = S.ref_norm;
    else
        error('MAT 파일에서 ref_final_scaled 또는 ref_norm 변수를 찾지 못했습니다: %s', matFilePath);
    end

    % Best K 값 로드 (존재할 경우)
    best_K_val = -1;
    if isfield(S, 'best_K')
        best_K_val = S.best_K;
    end
    
    disp('===== EXPORTER DEBUG =====');
    disp(['best_K_val (from mat) = ', num2str(best_K_val)]);
    disp(['data size = ', mat2str(size(data))]);

    disp('first 10 rows of data [x y label]:');
    disp(data(1:min(10,size(data,1)), :));

    disp('last 10 rows of data [x y label]:');
    disp(data(max(1,size(data,1)-9):size(data,1), :));
    disp('==========================');

    if size(data,2) < 3
        error('데이터 형식이 예상과 다릅니다. 최소 3열(X,Y,label)이 필요합니다.');
    end

    xy = data(:,1:2);
    labels = data(:,3);

    valid = all(isfinite(xy),2) & ismember(labels, [1 2]); % STS=1, SOS=2
    xy = xy(valid,:);
    labels = labels(valid);

    idxSTS = find(labels == 1);
    idxSOS = find(labels == 2);

    if isempty(idxSTS) || isempty(idxSOS)
        error('STS 또는 SOS 데이터가 비어있습니다. 라벨 매핑(STS=1, SOS=2)을 확인하세요.');
    end

    % 정렬: STS 먼저, SOS 나중
    xy_out = single([xy(idxSTS,:); xy(idxSOS,:)]);
    N_STS = numel(idxSTS);
    N_SOS = numel(idxSOS);
    N = N_STS + N_SOS;

    %% 1. C Header 파일 생성 (.h)
    fid = fopen(outHeaderPath, 'w');
    if fid < 0
        error('헤더 파일을 열 수 없습니다: %s', outHeaderPath);
    end
    c = onCleanup(@() fclose(fid)); % 함수 종료 시 자동 닫기

    fprintf(fid, '#pragma once\n');
    fprintf(fid, '#include <stdint.h>\n\n');
    fprintf(fid, '// Best K from MATLAB Analysis: %d\n', best_K_val);
    fprintf(fid, '#define REF_COUNT %uu\n', uint32(N));
    fprintf(fid, '#define REF_TYPE1_COUNT %uu\n', uint32(N_STS));
    fprintf(fid, '#define REF_TYPE2_COUNT %uu\n\n', uint32(N_SOS));

    fprintf(fid, 'static inline uint8_t ref_label(unsigned idx) { return idx < REF_TYPE1_COUNT ? 1u : 2u; }\n\n');
    fprintf(fid, 'static const float ref_xy[%u][2] = {\n', uint32(N));

    for i = 1:N
        if i < N
            fprintf(fid, '    { %.9ff, %.9ff },\n', xy_out(i,1), xy_out(i,2));
        else
            fprintf(fid, '    { %.9ff, %.9ff }\n',  xy_out(i,1), xy_out(i,2));
        end
    end
    fprintf(fid, '};\n');
    
    % (C 헤더 파일 닫힘 - onCleanup에 의해)

    %% 2. Python용 텍스트 파일 생성 (.txt)
    [p, n, ~] = fileparts(outHeaderPath);
    outPyPath = fullfile(p, [n, '_python.txt']); % 같은 경로, 같은 이름, .txt 확장자

    fidPy = fopen(outPyPath, 'w');
    if fidPy < 0
        warning('Python용 파일을 생성할 수 없습니다: %s', outPyPath);
    else
        fprintf(fidPy, '# ==========================================\n');
        fprintf(fidPy, '# Auto-generated by MATLAB (export_knn_ref_dataset_header.m)\n');
        fprintf(fidPy, '# Generated Date: %s\n', datestr(now));
        fprintf(fidPy, '# Copy and paste the block below into your Python code.\n');
        fprintf(fidPy, '# ==========================================\n\n');
        
        % Python 변수 출력 (split, k)
        fprintf(fidPy, '# --- [Parameter Update] ---\n');
        if best_K_val > 0
            fprintf(fidPy, 'k = %d         # Updated Best K from MATLAB\n', best_K_val);
        else
            fprintf(fidPy, '# k = 23       # (Best K not found in MAT file, check manually)\n');
        end
        fprintf(fidPy, 'split = %d     # STS Count (Label 1)\n\n', N_STS);
        
        % Python 데이터 어레이 출력
        fprintf(fidPy, '# --- [Data Update] ---\n');
        fprintf(fidPy, 'ref_xy = np.array([\n');
        for i = 1:N
            if i < N
                fprintf(fidPy, '    [%.9f, %.9f],\n', xy_out(i,1), xy_out(i,2));
            else
                fprintf(fidPy, '    [%.9f, %.9f]\n',  xy_out(i,1), xy_out(i,2));
            end
        end
        fprintf(fidPy, '])\n');
        
        fclose(fidPy);
    end

    %% 결과 출력
    fprintf('Generated C Header: %s\n', outHeaderPath);
    fprintf('Generated Python Data: %s\n', outPyPath);
    fprintf('STS(label=1): %d points\n', N_STS);
    fprintf('SOS(label=2): %d points\n', N_SOS);
    
    if best_K_val > 0
        fprintf('Best K: %d\n', best_K_val);
    end

    if nargin == 0
        msgbox(sprintf("Completed.\n\n[C Header]\n%s\n\n[Python Data]\n%s", outHeaderPath, outPyPath), 'Export Success');
    end
end